<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Detec√ß√£o SlushWallet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .result {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üîç Teste de Detec√ß√£o SlushWallet</h1>
    
    <div class="result">
        <h2>Status da Detec√ß√£o</h2>
        <div id="status">Verificando...</div>
    </div>

    <div class="result">
        <h2>Informa√ß√µes da Wallet</h2>
        <pre id="walletInfo">Nenhuma informa√ß√£o dispon√≠vel</pre>
    </div>

    <div class="result">
        <h2>A√ß√µes</h2>
        <button onclick="testConnect()">Testar Conex√£o</button>
        <button onclick="checkWindow()">Verificar window</button>
        <button onclick="location.reload()">Recarregar P√°gina</button>
    </div>

    <div class="result">
        <h2>Logs</h2>
        <pre id="logs"></pre>
    </div>

    <script>
        let wallet = null;
        const logsEl = document.getElementById('logs');
        
        function log(msg, type = 'info') {
            console.log(msg);
            const timestamp = new Date().toLocaleTimeString();
            logsEl.textContent += `[${timestamp}] ${msg}\n`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        function detectWallet() {
            log('Iniciando detec√ß√£o de wallet...');
            
            // Verificar window.slushWallet
            if (window.slushWallet) {
                wallet = window.slushWallet;
                log('‚úÖ SlushWallet encontrada em window.slushWallet', 'success');
                return true;
            }
            log('‚ùå window.slushWallet n√£o encontrado');
            
            // Verificar window.suiWallet
            if (window.suiWallet) {
                if (window.suiWallet.name && window.suiWallet.name.toLowerCase().includes('slush')) {
                    wallet = window.suiWallet;
                    log('‚úÖ SlushWallet encontrada em window.suiWallet', 'success');
                    return true;
                }
                log('‚ö†Ô∏è window.suiWallet existe mas n√£o √© SlushWallet');
            } else {
                log('‚ùå window.suiWallet n√£o encontrado');
            }
            
            // Verificar window.wallets
            if (window.wallets) {
                log(`‚ÑπÔ∏è window.wallets existe (tipo: ${typeof window.wallets})`);
                if (Array.isArray(window.wallets)) {
                    log(`‚ÑπÔ∏è window.wallets √© um array com ${window.wallets.length} itens`);
                    const slush = window.wallets.find(w => 
                        w && w.name && w.name.toLowerCase().includes('slush')
                    );
                    if (slush) {
                        wallet = slush;
                        log('‚úÖ SlushWallet encontrada em window.wallets', 'success');
                        return true;
                    }
                    log('‚ùå SlushWallet n√£o encontrada em window.wallets');
                } else {
                    log('‚ö†Ô∏è window.wallets n√£o √© um array');
                }
            } else {
                log('‚ùå window.wallets n√£o encontrado');
            }
            
            return false;
        }

        function updateUI() {
            const statusEl = document.getElementById('status');
            const infoEl = document.getElementById('walletInfo');
            
            if (wallet) {
                statusEl.innerHTML = '<span class="success">‚úÖ SlushWallet detectada!</span>';
                infoEl.textContent = JSON.stringify({
                    name: wallet.name || 'N/A',
                    version: wallet.version || 'N/A',
                    accounts: wallet.accounts || [],
                    features: wallet.features ? Object.keys(wallet.features) : [],
                    hasConnect: !!wallet.connect,
                    hasRequestPermissions: !!wallet.requestPermissions,
                }, null, 2);
            } else {
                statusEl.innerHTML = '<span class="error">‚ùå SlushWallet n√£o encontrada</span>';
                infoEl.textContent = 'Certifique-se que a extens√£o SlushWallet est√° instalada e ativa no Chrome.';
            }
        }

        async function testConnect() {
            if (!wallet) {
                alert('SlushWallet n√£o detectada. Instale a extens√£o primeiro.');
                return;
            }
            
            log('Tentando conectar...');
            
            try {
                let result;
                
                if (wallet.features && wallet.features['standard:connect']) {
                    log('Usando features[standard:connect]...');
                    result = await wallet.features['standard:connect'].connect();
                } else if (wallet.requestPermissions) {
                    log('Usando requestPermissions()...');
                    result = await wallet.requestPermissions();
                } else if (wallet.connect) {
                    log('Usando connect()...');
                    result = await wallet.connect();
                } else {
                    throw new Error('Nenhum m√©todo de conex√£o dispon√≠vel');
                }
                
                log('‚úÖ Conex√£o bem-sucedida!');
                log('Resultado: ' + JSON.stringify(result, null, 2));
                
                if (result.accounts && result.accounts.length > 0) {
                    alert('Conectado! Endere√ßo: ' + result.accounts[0].address);
                }
                
                updateUI();
            } catch (err) {
                log('‚ùå Erro ao conectar: ' + err.message, 'error');
                alert('Erro: ' + err.message);
            }
        }

        function checkWindow() {
            log('=== Objetos no window ===');
            log('window.slushWallet: ' + (window.slushWallet ? 'existe' : 'n√£o existe'));
            log('window.suiWallet: ' + (window.suiWallet ? 'existe' : 'n√£o existe'));
            log('window.wallets: ' + (window.wallets ? typeof window.wallets : 'n√£o existe'));
            
            // Verificar todos os objetos window
            log('\n=== Todas as propriedades do window ===');
            const allKeys = Object.keys(window);
            log('Total de propriedades: ' + allKeys.length);
            
            // Procurar por objetos que podem ser a wallet
            const walletKeys = allKeys.filter(k => 
                k.toLowerCase().includes('wallet') || 
                k.toLowerCase().includes('sui') ||
                k.toLowerCase().includes('slush')
            );
            
            if (walletKeys.length > 0) {
                log('Chaves relacionadas encontradas: ' + walletKeys.join(', '));
                walletKeys.forEach(key => {
                    log(`  ${key}: ${typeof window[key]}`);
                    if (typeof window[key] === 'object' && window[key]) {
                        log(`    Propriedades: ${Object.keys(window[key]).join(', ')}`);
                    }
                });
            } else {
                log('‚ùå Nenhuma chave relacionada encontrada no window');
            }
            
            // Verificar extens√µes Chrome
            log('\n=== Verifica√ß√£o de Extens√µes Chrome ===');
            if (window.chrome && window.chrome.runtime) {
                log('‚úÖ chrome.runtime existe');
                log('ID da extens√£o (se dispon√≠vel): ' + (window.chrome.runtime.id || 'N/A'));
            } else {
                log('‚ùå chrome.runtime n√£o encontrado');
            }
            
            // Verificar eventos de extens√£o
            log('\n=== Aguardando eventos de extens√£o ===');
            log('Algumas extens√µes carregam ap√≥s um evento. Tentando...');
            
            window.dispatchEvent(new Event('load'));
            setTimeout(() => {
                log('Verificando novamente ap√≥s dispatch de evento load...');
                if (window.slushWallet || window.suiWallet || window.wallets) {
                    log('‚úÖ Wallet encontrada ap√≥s evento!');
                    detectWallet();
                    updateUI();
                } else {
                    log('‚ùå Ainda n√£o encontrada');
                }
            }, 500);
        }

        // Executar detec√ß√£o ao carregar
        window.addEventListener('load', () => {
            log('P√°gina carregada, iniciando detec√ß√£o...');
            
            // Tentar imediatamente
            if (!detectWallet()) {
                log('Wallet n√£o encontrada, aguardando 1 segundo...');
                // Tentar novamente ap√≥s 1 segundo
                setTimeout(() => {
                    if (detectWallet()) {
                        updateUI();
                    } else {
                        log('‚ùå Wallet ainda n√£o encontrada ap√≥s aguardar');
                        updateUI();
                    }
                }, 1000);
            } else {
                updateUI();
            }
        });
    </script>
</body>
</html>
